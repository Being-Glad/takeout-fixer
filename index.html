<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PhotoTakeout Fixer Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        indigo: { 400: '#818cf8', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
                        purple: { 400: '#c084fc', 500: '#a855f7', 600: '#9333ea' },
                        gray: { 800: '#1f2937', 900: '#111827', 950: '#09090b' }
                    },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; user-select: none; }
        #titlebar { -webkit-app-region: drag; }
        .no-drag { -webkit-app-region: no-drag; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        .platform-darwin #titlebar-content { padding-left: 70px; }
    </style>
</head>

<body class="bg-gray-950 text-gray-100 flex flex-col h-screen overflow-hidden">

    <!-- Custom Titlebar -->
    <div id="titlebar" class="bg-gray-900/80 backdrop-blur-md h-12 flex items-center justify-between fixed top-0 left-0 right-0 z-50 border-b border-white/5">
        <div id="titlebar-content" class="flex items-center gap-2 pl-4">
             <svg class="w-6 h-6" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="100" height="100" rx="20" fill="#18181b"/>
                <rect x="25" y="25" width="20" height="20" rx="3" fill="#a855f7"/>
                <rect x="55" y="25" width="20" height="20" rx="3" fill="#6d28d9"/>
                <rect x="25" y="55" width="50" height="20" rx="3" fill="#4f46e5"/>
            </svg>
             <span class="text-sm font-semibold">Takeout Date Fixer</span>
        </div>
        <a href="https://buymeacoffee.com/Being_Glad" id="support-btn" target="_blank" class="no-drag mr-4 hidden sm:inline-flex items-center px-3 py-1.5 border border-yellow-500/50 text-sm font-medium rounded-md text-yellow-500 hover:bg-yellow-500/10 transition">
            â˜• Support Development
        </a>
    </div>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col items-center justify-center p-6 mt-10 relative">

        <!-- Idle State (Selection) -->
        <div id="state-idle" class="w-full max-w-4xl flex flex-col items-center space-y-8 transition-all duration-500 animate-fade-in-up">
            <div class="text-center space-y-6">
                <div class="inline-flex items-center justify-center mb-4">
                    <svg class="w-24 h-24 drop-shadow-2xl" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect width="100" height="100" rx="20" fill="#18181b"/>
                        <rect x="25" y="25" width="20" height="20" rx="3" fill="#a855f7"/>
                        <rect x="55" y="25" width="20" height="20" rx="3" fill="#6d28d9"/>
                        <rect x="25" y="55" width="50" height="20" rx="3" fill="#4f46e5"/>
                    </svg>
                </div>
                <h1 class="text-5xl font-extrabold tracking-tight">
                    Select your <span class="text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-indigo-400">Takeout Folder</span>
                </h1>
                <p class="text-gray-400 text-xl max-w-2xl mx-auto">
                    We'll scan your entire library, re-attach lost metadata, and organize your memories.
                </p>
            </div>
            <button id="select-folder-btn" class="group relative inline-flex items-center justify-center no-drag transform hover:scale-105 transition duration-300">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-purple-500 to-indigo-500 rounded-2xl blur opacity-60 group-hover:opacity-100 transition duration-500 animate-pulse-slow"></div>
                <div class="relative bg-gray-900 px-10 py-6 rounded-2xl flex items-center gap-4 text-2xl font-bold hover:bg-gray-800 transition-colors">
                    <svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v8a2 2 0 01-2 2H5z"/></svg>
                    <span>Browse Folder...</span>
                </div>
            </button>
        </div>

        <!-- Options State -->
        <div id="state-options" class="hidden w-full max-w-3xl bg-gray-900/80 border border-white/10 rounded-3xl p-8 backdrop-blur-xl space-y-8 animate-fade-in-up">
            <div>
                <h2 class="text-2xl font-bold text-white mb-2">Processing Options</h2>
                <p class="text-gray-400">Selected: <span id="selected-path" class="font-mono text-indigo-300 break-all"></span></p>
            </div>

            <div class="space-y-6">
                <!-- Mode Selection -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <label class="cursor-pointer no-drag">
                        <input type="radio" name="mode" value="inplace" class="peer hidden" checked>
                        <div class="h-full p-5 bg-gray-950 border-2 border-gray-800 rounded-2xl peer-checked:border-indigo-500 peer-checked:bg-indigo-500/10 transition hover:border-gray-700">
                            <div class="font-bold text-lg mb-2 peer-checked:text-indigo-400">Fix In-Place</div>
                            <p class="text-sm text-gray-500">Modifies files directly. Fastest, no extra disk space. (Recommended)</p>
                        </div>
                    </label>
                    <label class="cursor-pointer no-drag">
                        <input type="radio" name="mode" value="merge" class="peer hidden">
                         <div class="h-full p-5 bg-gray-950 border-2 border-gray-800 rounded-2xl peer-checked:border-indigo-500 peer-checked:bg-indigo-500/10 transition hover:border-gray-700">
                            <div class="font-bold text-lg mb-2 peer-checked:text-indigo-400">Merge to New Folder</div>
                            <p class="text-sm text-gray-500">Copies fixed files (and skips) to a new, clean folder, preserving album structure.</p>
                        </div>
                    </label>
                    <label class="cursor-pointer no-drag">
                        <input type="radio" name="mode" value="zip" class="peer hidden">
                         <div class="h-full p-5 bg-gray-950 border-2 border-gray-800 rounded-2xl peer-checked:border-indigo-500 peer-checked:bg-indigo-500/10 transition hover:border-gray-700">
                            <div class="font-bold text-lg mb-2 peer-checked:text-indigo-400">Create Zip Archive</div>
                            <p class="text-sm text-gray-500">Creates a single large .zip file of your fixed library. Good for backups.</p>
                        </div>
                    </label>
                </div>
            </div>

            <div class="flex gap-4">
                <button id="cancel-options-btn" class="px-6 py-3 rounded-xl font-semibold text-gray-400 hover:bg-gray-800 transition no-drag">Cancel</button>
                <button id="start-processing-btn" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold transition no-drag">
                    Start Fixing Photos
                </button>
            </div>
        </div>

        <!-- Processing State -->
        <!-- FIX: Added w-full -->
        <div id="state-processing" class="hidden w-full max-w-4xl bg-gray-900/50 border border-white/10 rounded-3xl p-8 backdrop-blur-xl animate-fade-in-up">
             <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold flex items-center gap-3">
                    <div class="relative flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-indigo-500"></span>
                    </div>
                    Processing Library...
                </h2>
                <div id="time-remaining" class="text-sm font-mono text-gray-400">Calculating...</div>
            </div>
            <div class="h-4 bg-gray-950 rounded-full overflow-hidden ring-1 ring-white/5 mb-4">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 w-0 transition-all duration-300 ease-out"></div>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-gray-950/50 p-4 rounded-2xl border border-white/5 text-center">
                    <div id="stat-total" class="text-2xl font-bold text-white">0</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wider font-medium">Total Files</div>
                </div>
                <div class="bg-gray-950/50 p-4 rounded-2xl border border-green-500/10 text-center">
                    <div id="stat-fixed" class="text-2xl font-bold text-green-400">0</div>
                    <div class="text-xs text-green-500/70 uppercase tracking-wider font-medium">Fixed</div>
                </div>
                <div class="bg-gray-950/50 p-4 rounded-2xl border border-yellow-500/10 text-center">
                    <div id="stat-failed" class="text-2xl font-bold text-yellow-400">0</div>
                    <div class="text-xs text-yellow-500/70 uppercase tracking-wider font-medium">Skipped</div>
                </div>
            </div>
            <div class="bg-black/30 rounded-xl p-4 h-48 overflow-y-auto font-mono text-xs text-gray-400 space-y-1 w-full" id="log-container">
                <div class="text-gray-500 italic">Waiting for start...</div>
            </div>
        </div>

        <!-- Complete State -->
        <div id="state-complete" class="hidden w-full max-w-xl text-center space-y-6 animate-fade-in-up">
             <div class="inline-flex items-center justify-center p-4 bg-green-500/10 rounded-full mb-4 ring-1 ring-green-500/20">
                <svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            </div>
            <h2 class="text-4xl font-bold text-white">All Done!</h2>
            <p id="completion-msg" class="text-xl text-gray-300">Your library has been successfully fixed.</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <!-- FIX: Added hidden class, it will be shown on complete -->
                <button id="open-folder-btn" class="hidden bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold transition-colors no-drag">
                    Open Output Folder
                </button>
                <button id="reset-btn" class="bg-gray-800 hover:bg-gray-700 text-white px-8 py-3 rounded-xl font-semibold transition-colors no-drag">
                    Process Another
                </button>
            </div>
        </div>

    </main>

    <script>
        // CRITICAL FIX: Wait for the DOM to be fully loaded
        window.addEventListener('DOMContentLoaded', () => {
            const electron = window.electron;
            const isDesktop = !!electron;

            // DOM Elements
            const states = {
                idle: document.getElementById('state-idle'),
                options: document.getElementById('state-options'),
                processing: document.getElementById('state-processing'),
                complete: document.getElementById('state-complete')
            };
            const btns = {
                select: document.getElementById('select-folder-btn'),
                start: document.getElementById('start-processing-btn'),
                cancelOptions: document.getElementById('cancel-options-btn'),
                reset: document.getElementById('reset-btn'),
                openFolder: document.getElementById('open-folder-btn'),
                support: document.getElementById('support-btn')
            };
            const ui = {
                selectedPath: document.getElementById('selected-path'),
                progressBar: document.getElementById('progress-bar'),
                logContainer: document.getElementById('log-container'),
                completionMsg: document.getElementById('completion-msg'),
                timeRemaining: document.getElementById('time-remaining'),
                stats: {
                    total: document.getElementById('stat-total'),
                    fixed: document.getElementById('stat-fixed'),
                    failed: document.getElementById('stat-failed')
                }
            };

            let selectedFolder = null;
            let lastOutputPath = null;
            let processingStartTime = 0;

            function showState(stateKey) {
                Object.values(states).forEach(el => el.classList.add('hidden'));
                states[stateKey].classList.remove('hidden');
            }

            let logHasContent = false;
            function addLog(msg, type = 'info') {
                if (!logHasContent) {
                    ui.logContainer.innerHTML = '';
                    logHasContent = true;
                }
                const div = document.createElement('div');
                
                // ** FIX for [object Object] BUG **
                // Defensively stringify any non-string messages
                const logMsg = (typeof msg === 'string') ? msg : JSON.stringify(msg);
                div.textContent = `> ${logMsg}`;
                
                // Set text color based on type
                if (type === 'error') div.className = 'text-red-400';
                else if (type === 'success') div.className = 'text-green-500';
                else if (type === 'warn') div.className = 'text-yellow-400';
                else div.className = 'text-gray-300';
                
                div.className += ' break-all'; // Add break-all for long paths
                
                ui.logContainer.appendChild(div);
                ui.logContainer.scrollTop = ui.logContainer.scrollHeight;
            }

            // --- Event Listeners ---
            btns.select.addEventListener('click', async () => {
                if (!isDesktop) {
                    alert("This feature only works in the desktop app.");
                    return;
                }
                try {
                    const path = await electron.openDirectory();
                    if (path) {
                        selectedFolder = path;
                        ui.selectedPath.textContent = path;
                        showState('options');
                    }
                } catch (e) {
                    alert("Error opening directory: " + e.message);
                }
            });

            btns.cancelOptions.addEventListener('click', () => {
                selectedFolder = null;
                showState('idle');
            });

            btns.start.addEventListener('click', () => {
                if (!selectedFolder) return;
                const mode = document.querySelector('input[name="mode"]:checked').value;
                
                showState('processing');
                // Reset UI
                ui.progressBar.style.width = '0%';
                Object.values(ui.stats).forEach(el => el.textContent = '0');
                ui.logContainer.innerHTML = '';
                logHasContent = false;
                lastOutputPath = null;
                processingStartTime = Date.now();
                ui.timeRemaining.textContent = 'Calculating...';
                addLog(`Starting... Mode: ${mode}`);
                
                electron.startProcessing({ 
                    paths: [selectedFolder], 
                    mode
                });
            });

            btns.reset.addEventListener('click', () => {
                selectedFolder = null;
                lastOutputPath = null;
                btns.openFolder.classList.add('hidden'); // Hide button on reset
                showState('idle');
            });

            btns.openFolder.addEventListener('click', () => {
                // ** FIX: Call correct IPC handler **
                if (lastOutputPath && electron.openFolder) {
                    electron.openFolder(lastOutputPath);
                }
            });
            
            btns.support.addEventListener('click', (e) => {
                e.preventDefault();
                if (electron.openExternal) {
                    electron.openExternal(e.currentTarget.href);
                }
            });

            // --- Electron IPC Setup ---
            if (isDesktop) {
                electron.onUpdateProgress((current, total) => {
                    const percent = Math.round((current / total) * 100) || 0;
                    ui.progressBar.style.width = `${percent}%`;
                    ui.stats.total.textContent = total.toLocaleString();

                    // Time remaining estimation
                    if (processingStartTime > 0 && current > 10) {
                        const elapsedMs = Date.now() - processingStartTime;
                        const msPerFile = elapsedMs / current;
                        const remainingMs = msPerFile * (total - current);
                        const remainingSec = Math.round(remainingMs / 1000);
                        if (remainingSec < 60) {
                            ui.timeRemaining.textContent = `${remainingSec}s left`;
                        } else {
                            ui.timeRemaining.textContent = `${Math.round(remainingSec / 60)}m left`;
                        }
                    }
                });
                
                electron.onLog((msg, type) => {
                    addLog(msg, type);
                    // This is a simple/brittle way to track, but OK for now
                    if (msg.includes('Fixed:')) {
                        ui.stats.fixed.textContent = (parseInt(ui.stats.fixed.textContent) + 1).toLocaleString();
                    } else if (msg.includes('Failed:') || msg.includes('Skipping')) {
                        ui.stats.failed.textContent = (parseInt(ui.stats.failed.textContent) + 1).toLocaleString();
                    }
                });

                electron.onComplete((stats) => {
                    // Use final stats from main for accuracy
                    ui.stats.total.textContent = stats.total.toLocaleString();
                    ui.stats.fixed.textContent = stats.fixed.toLocaleString();
                    ui.stats.failed.textContent = stats.failed.toLocaleString();
                    ui.progressBar.style.width = '100%';
                    ui.timeRemaining.textContent = 'Complete!';
                    
                    lastOutputPath = stats.outputPath;
                    
                    if(stats.fixed === 0 && stats.failed === 0 && stats.total > 0) {
                         ui.completionMsg.textContent = `Scanned ${stats.total.toLocaleString()} files, but no metadata could be fixed.`;
                    } else {
                         ui.completionMsg.innerHTML = `Successfully fixed <b>${stats.fixed.toLocaleString()}</b> files. <span class="text-yellow-400">${stats.failed.toLocaleString()} skipped.</span>`;
                    }
                    
                    // Only show "Open Folder" if an output path was generated (i.e., not "In-Place" on a failed run)
                    if (!lastOutputPath || stats.outputPath === selectedFolder) {
                        btns.openFolder.classList.add('hidden');
                        btns.reset.textContent = "Process Another Folder";
                    } else {
                        btns.openFolder.classList.remove('hidden');
                        btns.reset.textContent = "Process Another";
                    }

                    showState('complete');
                });

                // Handle platform-specific UI tweaks
                electron.getPlatform().then(platform => {
                    if (platform === 'darwin') { // 'darwin' is the platform name for macOS
                        document.getElementById('titlebar-content').classList.add('platform-darwin');
                    }
                });
            }
        }); // End DOMContentLoaded
    </script>
</body>
</html>
